<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Gestión de Usuarios | Panel Admin</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
  </head>
  <body>
    <header class="header">
      <div class="header-container">
        <div class="logo-area">
          <a th:href="@{/}" class="site-title-link">
            <img th:src="@{/img/Logo.png}" alt="Logo" width="100px" />
          </a>
        </div>
        <div class="user-menu-container">
          <button id="userMenuBtn" class="user-button">
            <img
              th:src="${#authentication.principal.fotoPerfilUrl}"
              alt="Avatar"
              class="user-avatar"
              style="object-fit: cover"
            />
            <span th:text="${#authentication.principal.username}">Admin</span>
            <i class="fas fa-chevron-down"></i>
          </button>
          <div id="userDropdown" class="user-dropdown-content">
            <a th:href="@{/}" class="dropdown-item">
              <i class="fas fa-home"></i> Volver al Inicio
            </a>
            <form th:action="@{/logout}" method="post" style="margin: 0">
              <button type="submit">
                <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
              </button>
            </form>
          </div>
        </div>
      </div>
    </header>

    <main class="content-container">
      <div class="profile-wrapper">
        <aside class="profile-sidebar">
          <ul class="sidebar-menu">
            <li>
              <a th:href="@{/perfil}">
                <i class="fas fa-id-card" style="margin-right: 10px"></i> Datos
                Personales
              </a>
            </li>
            <li>
              <a href="#" style="color: #666; cursor: not-allowed">
                <i class="fas fa-heart" style="margin-right: 10px"></i> Mis
                Favoritos (Pronto)
              </a>
            </li>
            <li>
              <a th:href="@{/equipos/mis-equipos}">
                <i class="fas fa-users" style="margin-right: 10px"></i> Mis
                Equipos
              </a>
            </li>
            <li sec:authorize="hasRole('ADMIN')">
              <a th:href="@{/admin/usuarios}"
               class="active">
                <i
                  class="fas fa-users-cog"
                  style="margin-right: 10px; color: #000000"
                ></i>
                Gestión Usuarios
              </a>
            </li>
          </ul>
        </aside>

        <section class="profile-content">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 25px;
            "
          >
            <h2
              style="
                color: #ffde00;
                margin: 0;
                text-transform: uppercase;
                letter-spacing: 1px;
              "
            >
              <i class="fas fa-shield-alt"></i> Control de Usuarios
            </h2>
          </div>

          <div class="search-container" style="margin-bottom: 20px">
            <form th:action="@{/admin/usuarios}" method="get">
              <div style="position: relative">
                <i
                  class="fas fa-search"
                  style="position: absolute; left: 10px; top: 10px; color: #888"
                ></i>
                <input
                  type="text"
                  name="buscar"
                  th:value="${buscar}"
                  placeholder="Buscar por nombre o usuario..."
                  style="
                    padding-left: 35px;
                    background: #222;
                    border: 1px solid #444;
                    color: white;
                    border-radius: 5px;
                    padding-top: 8px;
                    padding-bottom: 8px;
                    width: 300px;
                  "
                />
              </div>

              <button
                type="submit"
                class="poke-button"
                style="font-size: 0.9em; padding: 8px 15px"
              >
                Buscar
              </button>

              <a
                th:if="${buscar != null && !buscar.isEmpty()}"
                th:href="@{/admin/usuarios}"
                class="btn-cancelar"
                style="
                  text-decoration: none;
                  font-size: 0.9em;
                  padding: 8px 15px;
                  display: inline-block;
                "
              >
                Limpiar Filtro
              </a>
            </form>
          </div>

          <div class="admin-table-container">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>
                    <a
                      th:href="@{/admin/usuarios(page=${currentPage}, sort='id', dir=${reverseDir}, buscar=${buscar})}"
                    >
                      ID <i class="fas fa-sort"></i>
                    </a>
                  </th>

                  <th>Avatar</th>

                  <th>
                    <a
                      th:href="@{/admin/usuarios(page=${currentPage}, sort='nombreCompleto', dir=${reverseDir}, buscar=${buscar})}"
                    >
                      Nombre <i class="fas fa-sort"></i>
                    </a>
                  </th>

                  <th>Usuario</th>
                  <th>Rol</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr th:each="usuario : ${usuarios}">
                  <td th:text="${usuario.id}" style="color: #888">#1</td>

                  <td>
                    <img
                      th:src="${usuario.fotoPerfilUrl}"
                      alt="Foto"
                      class="table-avatar"
                    />
                  </td>

                  <td
                    th:text="${usuario.nombreCompleto}"
                    style="font-weight: bold; color: white"
                  >
                    Nombre Apellido
                  </td>
                  <td th:text="'@' + ${usuario.username}" style="color: #aaa">
                    @usuario
                  </td>

                  <td>
                    <span
                      th:if="${usuario.rol == 'ADMIN'}"
                      class="role-badge role-admin"
                    >
                      <i class="fas fa-crown"></i> ADMIN
                    </span>
                    <span
                      th:if="${usuario.rol == 'USER'}"
                      class="role-badge role-user"
                    >
                      <i class="fas fa-user"></i> USER
                    </span>
                  </td>

                  <td>
                    <div style="display: flex; gap: 5px">
                      <span
                        th:if="${usuario.superAdmin}"
                        style="
                          color: #ffde00;
                          font-weight: bold;
                          padding: 6px 12px;
                          border: 2px solid #ffde00;
                          border-radius: 8px;
                          background: rgba(255, 222, 0, 0.15);
                          font-size: 0.85em;
                          display: inline-flex;
                          align-items: center;
                          gap: 6px;
                        "
                      >
                        <i class="fas fa-shield-alt"></i> SuperAdmin
                      </span>

                      <form
                        th:if="${usuario.rol != 'ADMIN'}"
                        th:action="@{/admin/usuarios/ascender/{id}(id=${usuario.id})}"
                        method="post"
                      >
                        <button
                          type="submit"
                          class="poke-button"
                          style="
                            background: #4caf50;
                            padding: 5px 10px;
                            font-size: 0.8em;
                          "
                          title="Ascender a Admin"
                        >
                          <i class="fas fa-arrow-up"></i>
                        </button>
                      </form>

                      <button
                        th:if="${usuario.rol == 'ADMIN' && !usuario.superAdmin}"
                        type="button"
                        class="poke-button"
                        style="
                          background: #ff9800;
                          padding: 5px 10px;
                          font-size: 0.8em;
                        "
                        title="Degradar a Usuario"
                        th:onclick="'degradarUsuario(' + ${usuario.id} + ')'"
                      >
                        <i class="fas fa-arrow-down"></i>
                      </button>

                      <button
                        th:if="${usuario.rol == 'USER' && !usuario.superAdmin}"
                        type="button"
                        class="poke-button"
                        style="
                          background: #d32f2f;
                          padding: 5px 10px;
                          font-size: 0.8em;
                        "
                        title="Eliminar Usuario"
                        th:data-url="@{/admin/usuarios/borrar/{id}(id=${usuario.id})}"
                        onclick="
                          abrirModalBorrar(this.getAttribute('data-url'))
                        "
                      >
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>

                <tr th:if="${usuarios.empty}">
                  <td
                    colspan="6"
                    style="text-align: center; padding: 30px; color: #888"
                  >
                    <i
                      class="fas fa-search"
                      style="font-size: 2em; margin-bottom: 10px"
                    ></i
                    ><br />
                    No se encontraron usuarios con ese criterio.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div
            th:if="${totalPages > 1}"
            class="pagination-container"
            style="
              margin-top: 25px;
              display: flex;
              justify-content: center;
              gap: 8px;
            "
          >
            <a
              th:if="${currentPage > 0}"
              th:href="@{/admin/usuarios(page=${currentPage - 1}, buscar=${buscar}, sort=${sort}, dir=${dir})}"
              class="poke-button"
              style="background: #444; font-size: 0.9em"
            >
              <i class="fas fa-chevron-left"></i> Anterior
            </a>

            <span th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
              <a
                th:href="@{/admin/usuarios(page=${i}, buscar=${buscar}, sort=${sort}, dir=${dir})}"
                th:text="${i + 1}"
                class="poke-button"
                th:style="${i == currentPage ? 'background: #FFDE00; color: black; font-weight: bold;' : 'background: #333; color: white;'}"
              >
                1
              </a>
            </span>

            <a
              th:if="${currentPage < totalPages - 1}"
              th:href="@{/admin/usuarios(page=${currentPage + 1}, buscar=${buscar}, sort=${sort}, dir=${dir})}"
              class="poke-button"
              style="background: #444; font-size: 0.9em"
            >
              Siguiente <i class="fas fa-chevron-right"></i>
            </a>
          </div>
        </section>
      </div>
    </main>

    <footer class="main-footer">
      <div class="footer-content-wrapper">
        <div class="footer-info">
          <img th:src="@{/img/Logo.png}" alt="Logo" class="footer-logo" />
          <p class="description">
            Panel de Administración del Diario de Kanto.<br />
            Gestiona entrenadores y mantén el orden en la región.
          </p>
        </div>
        <div class="footer-meta">
          <p class="creator">Creado por: Pablo Herrera Domínguez</p>
          <p class="copyright">©2025 El Diario de Kanto.</p>
        </div>
      </div>
    </footer>

    <div id="modalBorrar" class="modal-overlay">
      <div class="modal-box">
        <div style="font-size: 3rem; color: #d32f2f; margin-bottom: 15px">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h3 style="color: #ffde00; margin-bottom: 10px">¡Cuidado Admin!</h3>
        <p style="color: #ccc; margin-bottom: 15px">
          Estás a punto de eliminar un usuario permanentemente.<br />
          Para confirmar, escribe <strong>CONFIRMAR</strong>:
        </p>
        <form id="formBorrarModal" method="post" action="">
          <input
            type="text"
            id="inputConfirmacion"
            class="modal-input"
            placeholder="Escribe CONFIRMAR"
            onkeyup="validarBorrado()"
            autocomplete="off"
          />
          <div class="modal-buttons">
            <button
              type="button"
              class="btn-cancelar"
              onclick="cerrarModalBorrar()"
            >
              Cancelar
            </button>
            <button
              type="submit"
              id="btnBorrarReal"
              class="btn-confirmar-borrar"
              disabled
            >
              Eliminar
            </button>
          </div>
        </form>
      </div>
    </div>

    <script th:src="@{/js/main.js}"></script>

    <script>
      function degradarUsuario(id) {
        let confirmacion = prompt(
          "Escribe 'Confirmar' para quitar permisos de administrador:",
        );
        if (confirmacion === "Confirmar") {
          // Creamos un formulario invisible para hacer el POST
          let form = document.createElement("form");
          form.method = "POST";
          form.action = "/admin/usuarios/degradar/" + id;
          document.body.appendChild(form);
          form.submit();
        }
      }
    </script>
  </body>
</html>
