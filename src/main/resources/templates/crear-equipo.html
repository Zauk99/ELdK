<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Team Builder | El Diario de Kanto</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    
    <style>
        .hidden { display: none !important; }
        .step-indicator { color: #888; font-size: 0.9em; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; }
        .step-indicator span.active { color: #FFDE00; font-weight: bold; border-bottom: 2px solid #FFDE00; padding-bottom: 2px; }
        
        .pokemon-detail-card { background: #2a2a2a; border: 1px solid #444; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .pokemon-detail-header { display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #444; padding-bottom: 15px; margin-bottom: 15px; }
        .detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        
        /* Imagen */
        .poke-img-container { width: 80px; height: 80px; background: #151515; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid #444; overflow: hidden; }
        .poke-img-container img { width: 90%; height: auto; }
        
        /* Shiny toggle */
        .shiny-toggle { cursor: pointer; color: #555; font-size: 1.2em; transition: color 0.3s; }
        .shiny-toggle.active { color: #FFD700; text-shadow: 0 0 5px rgba(255, 215, 0, 0.6); }

        /* Panel Showdown */
        .showdown-panel { position: absolute; width: 400px; max-height: 500px; background-color: #1a1a1a; border: 1px solid #FFDE00; border-radius: 6px; box-shadow: 0 10px 40px rgba(0,0,0,0.95); z-index: 10000; display: flex; flex-direction: column; overflow: hidden; font-family: 'Roboto', sans-serif; }
        .panel-header { background: #333; padding: 10px; display: flex; justify-content: space-between; align-items: center; color: #FFDE00; font-weight: bold; }
        .panel-body { flex-grow: 1; overflow-y: auto; background: #252525; max-height: 250px; }
        .panel-list { list-style: none; padding: 0; margin: 0; }
        .panel-list li { padding: 10px; cursor: pointer; border-bottom: 1px solid #333; color: #ddd; }
        .panel-list li:hover { background-color: #3f51b5; color: white; }
        .panel-description { padding: 15px; background: #111; border-top: 1px solid #FFDE00; color: #ccc; font-size: 0.9em; min-height: 100px; }
        
        /* Badges */
        .move-stat-badge { display: inline-block; padding: 3px 8px; border-radius: 4px; background: #444; color: white; font-size: 0.85em; margin-right: 8px; border: 1px solid #666; }
        .cat-physical { background-color: #D32F2F; } .cat-special { background-color: #1976D2; } .cat-status { background-color: #757575; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-container">
            <div class="logo-area"><a th:href="@{/}" class="site-title-link"><img th:src="@{/img/Logo.png}" alt="Logo" width="100px"></a></div>
            <div style="display: flex; align-items: center;">
                <div sec:authorize="isAuthenticated()" class="user-menu-container">
                    <button id="userMenuBtn" class="user-button">
                        <img th:src="${#authentication.principal.fotoPerfilUrl}" alt="Avatar" class="user-avatar" style="object-fit: cover;">
                        <span th:text="${#authentication.principal.username}">Usuario</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div id="userDropdown" class="user-dropdown-content">
                        <a th:href="@{/perfil}" class="dropdown-item"><i class="fas fa-user"></i> Ver Perfil</a>
                        <form th:action="@{/logout}" method="post" style="margin: 0;">
                            <button type="submit"><i class="fas fa-sign-out-alt"></i> Cerrar Sesi贸n</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="content-container">
        <div style="background: #222; padding: 30px; border-radius: 10px; border: 1px solid #444; max-width: 1000px; margin: 0 auto;">
            
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                <h2 style="color: #FFDE00; margin: 0;"><i class="fas fa-tools"></i> Team Builder</h2>
                <div class="step-indicator">
                    <span id="labelPaso1" class="active">1. Selecci贸n</span>
                    <span style="margin: 0 10px;">></span>
                    <span id="labelPaso2">2. Estrategia</span>
                </div>
            </div>

            <div id="paso1">
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label style="color: #aaa; font-size: 0.9em;">Nombre del Equipo</label>
                        <input type="text" id="nombreEquipo" placeholder="Ej: Kanto Champs" style="width: 100%; padding: 10px; background: #333; color: white; border: 1px solid #555; border-radius: 5px; font-size: 1.1em; font-weight: bold;">
                    </div>
                    <div>
                        <label style="color: #aaa; font-size: 0.9em;">Descripci贸n</label>
                        <input type="text" id="descEquipo" placeholder="Breve descripci贸n..." style="width: 100%; padding: 10px; background: #333; color: white; border: 1px solid #555; border-radius: 5px;">
                    </div>
                </div>
                
                <div style="margin-bottom: 30px; display: flex; align-items: center; gap: 10px;">
                    <label style="color: #FFDE00; font-weight: bold;">Visibilidad:</label>
                    <select id="esPublico" style="padding: 10px; background: #333; color: white; border: 1px solid #555; border-radius: 5px;">
                        <option value="true"> P煤blico (Visible en Comunidad)</option>
                        <option value="false"> Privado (Solo para m铆)</option>
                    </select>
                </div>

                <div id="selection-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-bottom: 30px;"></div>

                <div style="text-align: right; border-top: 1px solid #333; padding-top: 20px;">
                    <a th:href="@{/equipos}" class="poke-button" style="background-color: #d32f2f; float: left;">Cancelar</a>
                    <button onclick="irAPaso2()" class="auth-submit-button" style="width: auto; padding: 12px 40px; background-color: #FFDE00; color: #222;">Siguiente <i class="fas fa-arrow-right"></i></button>
                </div>
            </div>

            <div id="paso2" class="hidden">
                <p style="color: #ccc; margin-bottom: 20px;"><i class="fas fa-info-circle"></i> Configura los detalles. Pulsa la estrella <i class="fas fa-star" style="color:gold"></i> para shiny.</p>
                <div id="detalles-container"></div>
                <div style="display: flex; justify-content: space-between; border-top: 1px solid #333; padding-top: 20px; margin-top: 20px;">
                    <button onclick="volverAPaso1()" class="poke-button" style="background-color: #444;"><i class="fas fa-arrow-left"></i> Volver</button>
                    <button onclick="guardarEquipoFinal()" class="auth-submit-button" style="width: auto; padding: 12px 40px; background-color: #4CAF50; color: white;"><i class="fas fa-save"></i> Guardar Equipo</button>
                </div>
            </div>
        </div>
    </main>

    <div id="showdown-panel" class="showdown-panel hidden">
        <div class="panel-header">
            <span id="panel-title">Opciones</span>
            <button onclick="cerrarPanel()" style="background:none; border:none; color:#888; cursor:pointer;"><i class="fas fa-times"></i></button>
        </div>
        <div class="panel-body"><ul id="panel-list" class="panel-list"></ul></div>
        <div id="panel-description" class="panel-description"></div>
    </div>

    <datalist id="allPokemonList">
        <option th:each="p : ${listaPokemon}" th:value="${p.nombre}"></option>
    </datalist>

    <script th:src="@{/js/main.js}"></script>

    <script th:inline="javascript">
        // --- UTILIDADES DE IMAGEN ---
        function getPokemonImage(name, isShiny) {
            if (!name) return "/img/pokeball-icon.png";
            let slug = name.toLowerCase().trim().replace(/ /g, '-');
            if (slug === 'mimikyu') slug = 'mimikyu-disguised';
            if (slug === 'aegislash') slug = 'aegislash-shield';
            if (slug === 'giratina') slug = 'giratina-altered';
            if (slug === 'deoxys') slug = 'deoxys-normal';

            const baseUrl = "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/home";
            return isShiny ? `${baseUrl}/shiny/${slug}.png` : `${baseUrl}/${slug}.png`;
        }

        // --- CACH Y DATOS ---
        const detailsCache = {};
        let equipoTemporal = { nombre: "", descripcion: "", publico: true, miembros: [] };
        const naturalezas = ["Firme", "Alegre", "Modesta", "Miedosa", "Osada", "Serena", "Cauta", "Agitada", "Rara", "Activa"];
        const optsNaturaleza = naturalezas.map(n => `<option value="${n}">${n}</option>`).join('');

        // --- INICIALIZACIN ---
        const selectionGrid = document.getElementById('selection-grid');
        for(let i=0; i<6; i++) {
            selectionGrid.innerHTML += `
                <div class="pokemon-slot" id="select-slot-${i}" style="background: #2a2a2a; padding: 15px; border-radius: 8px; border: 1px solid #444; display: flex; gap: 15px; align-items: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: #444; width: 20px;">${i+1}</div>
                    <div style="width: 50px; height: 50px; background: #111; border-radius: 50%; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 1px solid #333;">
                        <img id="prev-img-${i}" src="/img/pokeball-icon.png" style="max-width: 90%; opacity: 0.5;" onerror="this.src='/img/Logo.png'">
                    </div>
                    <div style="flex-grow: 1;">
                        <input type="text" class="poke-search-simple" id="poke-name-${i}" list="allPokemonList" placeholder="Elige Pok茅mon..." oninput="actualizarPreview(${i})" style="width: 100%; padding: 10px; background: #333; color: white; border: 1px solid #555; border-radius: 4px; font-weight: bold;">
                    </div>
                    <button onclick="limpiarInput(${i})" style="background: none; border: none; color: #d32f2f; cursor: pointer;"><i class="fas fa-trash"></i></button>
                </div>`;
        }

        function actualizarPreview(i) {
            const input = document.getElementById(`poke-name-${i}`);
            const img = document.getElementById(`prev-img-${i}`);
            const val = input.value.trim();
            if(val.length > 2) {
                img.src = getPokemonImage(val, false);
                img.style.opacity = "1";
            } else {
                img.src = "/img/pokeball-icon.png";
                img.style.opacity = "0.5";
            }
        }
        function limpiarInput(i) {
            document.getElementById(`poke-name-${i}`).value = '';
            actualizarPreview(i);
        }

        // --- TRANSICIN ---
        function irAPaso2() {
            const nombre = document.getElementById('nombreEquipo').value;
            if(!nombre) { alert("Ponle un nombre a tu equipo."); return; }

            const elegidos = [];
            for(let i=0; i<6; i++) {
                const val = document.getElementById(`poke-name-${i}`).value;
                if(val && val.trim() !== "") elegidos.push({ index: i, nombre: val });
            }

            if(elegidos.length === 0) { alert("Elige al menos 1 Pok茅mon."); return; }

            equipoTemporal.nombre = nombre;
            equipoTemporal.descripcion = document.getElementById('descEquipo').value;
            equipoTemporal.publico = document.getElementById('esPublico').value === 'true'; // Guardar estado p煤blico
            equipoTemporal.miembros = elegidos;

            renderizarDetalles(elegidos);
            document.getElementById('paso1').classList.add('hidden');
            document.getElementById('paso2').classList.remove('hidden');
            document.getElementById('labelPaso1').classList.remove('active');
            document.getElementById('labelPaso2').classList.add('active');
            window.scrollTo(0, 0);
        }

        function volverAPaso1() {
            document.getElementById('paso2').classList.add('hidden');
            document.getElementById('paso1').classList.remove('hidden');
            document.getElementById('labelPaso2').classList.remove('active');
            document.getElementById('labelPaso1').classList.add('active');
            cerrarPanel();
        }

        function renderizarDetalles(miembros) {
            const container = document.getElementById('detalles-container');
            container.innerHTML = "";
            miembros.forEach((m, i) => {
                const nombreCap = m.nombre.charAt(0).toUpperCase() + m.nombre.slice(1);
                const imgUrl = getPokemonImage(m.nombre, false);
                const html = `
                <div class="pokemon-detail-card" id="detail-card-${i}">
                    <div class="pokemon-detail-header">
                        <div class="poke-img-container">
                            <img id="detail-img-${i}" src="${imgUrl}" alt="${nombreCap}">
                        </div>
                        <div style="flex-grow: 1; margin-left: 10px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <h3 style="margin: 0; color: white;">${nombreCap}</h3>
                                <i class="fas fa-star shiny-toggle" id="shiny-btn-${i}" onclick="toggleShiny(${i}, '${m.nombre}')"></i>
                                <input type="hidden" class="d-shiny-val" id="shiny-val-${i}" value="false">
                            </div>
                            <span style="color: #666; font-size: 0.8em; font-weight: bold;">#${i+1}</span>
                        </div>
                        <input type="hidden" class="d-nombre" value="${m.nombre}">
                    </div>
                    <div class="detail-grid">
                        <div>
                            <label style="color:#aaa; font-size:0.8em;">Mote</label>
                            <input type="text" class="d-mote" placeholder="${nombreCap}" style="width:100%; padding:8px; background:#111; color:white; border:1px solid #555; border-radius:4px; margin-bottom:10px;">
                            <label style="color:#aaa; font-size:0.8em;">Objeto</label>
                            <input type="text" class="d-objeto" placeholder="Ej: Restos" onclick="abrirSelector(this, 'Objeto', ${i})" readonly style="width:100%; padding:8px; background:#111; color:white; border:1px solid #555; border-radius:4px; margin-bottom:10px; cursor:pointer;">
                            <label style="color:#aaa; font-size:0.8em;">Habilidad</label>
                            <input type="text" class="d-habilidad" placeholder="Ej: Intimidaci贸n" onclick="abrirSelector(this, 'Habilidad', ${i})" readonly style="width:100%; padding:8px; background:#111; color:white; border:1px solid #555; border-radius:4px; cursor:pointer;">
                        </div>
                        <div>
                            <label style="color:#aaa; font-size:0.8em;">Naturaleza</label>
                            <select class="d-naturaleza" style="width:100%; padding:8px; background:#111; color:white; border:1px solid #555; border-radius:4px;">
                                <option value="">Neutra</option>${optsNaturaleza}
                            </select>
                        </div>
                        <div>
                            <label style="color:#FFDE00; font-size:0.8em; font-weight:bold; display:block; margin-bottom:5px;">Set de Movimientos</label>
                            <input type="text" class="d-move-1" placeholder="- Movimiento 1" onclick="abrirSelector(this, 'Movimiento', ${i})" readonly style="width:100%; padding:6px; background:#111; color:#ddd; border:1px solid #555; border-radius:4px; margin-bottom:5px; cursor:pointer;">
                            <input type="text" class="d-move-2" placeholder="- Movimiento 2" onclick="abrirSelector(this, 'Movimiento', ${i})" readonly style="width:100%; padding:6px; background:#111; color:#ddd; border:1px solid #555; border-radius:4px; margin-bottom:5px; cursor:pointer;">
                            <input type="text" class="d-move-3" placeholder="- Movimiento 3" onclick="abrirSelector(this, 'Movimiento', ${i})" readonly style="width:100%; padding:6px; background:#111; color:#ddd; border:1px solid #555; border-radius:4px; margin-bottom:5px; cursor:pointer;">
                            <input type="text" class="d-move-4" placeholder="- Movimiento 4" onclick="abrirSelector(this, 'Movimiento', ${i})" readonly style="width:100%; padding:6px; background:#111; color:#ddd; border:1px solid #555; border-radius:4px; cursor:pointer;">
                        </div>
                    </div>
                </div>`;
                container.innerHTML += html;
            });
        }

        // --- SHINY TOGGLE ---
        function toggleShiny(index, nombre) {
            const img = document.getElementById(`detail-img-${index}`);
            const btn = document.getElementById(`shiny-btn-${index}`);
            const inputVal = document.getElementById(`shiny-val-${index}`);
            const newState = !(inputVal.value === "true");
            inputVal.value = newState;
            if (newState) { btn.classList.add('active'); img.src = getPokemonImage(nombre, true); } 
            else { btn.classList.remove('active'); img.src = getPokemonImage(nombre, false); }
        }

        // --- SHOWDOWN PANEL LOGIC ---
        const objetosComunes = ["Leftovers", "Life Orb", "Choice Scarf", "Choice Band", "Choice Specs", "Assault Vest", "Sitrus Berry", "Lum Berry", "Rocky Helmet", "Black Sludge", "Eviolite", "Focus Sash"];

        function abrirSelector(input, tipo, slotIndex) {
            const nombrePoke = document.querySelector(`#detail-card-${slotIndex} .d-nombre`).value;
            if (!nombrePoke) return;

            const panel = document.getElementById('showdown-panel');
            const rect = input.getBoundingClientRect();
            const scrollTop = window.scrollY || document.documentElement.scrollTop;
            panel.style.top = (rect.top + scrollTop - 100) + 'px';
            panel.style.left = (rect.right + 15) + 'px'; 
            panel.classList.remove('hidden');
            
            document.getElementById('panel-title').innerText = `Elegir ${tipo}`;
            const lista = document.getElementById('panel-list');
            lista.innerHTML = '<li style="color:#888; text-align:center;">Cargando...</li>';
            document.getElementById('panel-description').innerHTML = '<p style="color:#aaa; text-align:center;">Pasa el rat贸n para ver detalles.</p>';

            if (tipo === 'Objeto') {
                mostrarOpcionesSimple(objetosComunes, input, 'item');
            } else {
                fetch(`https://pokeapi.co/api/v2/pokemon/${nombrePoke.toLowerCase()}`)
                    .then(res => res.json())
                    .then(data => {
                        let opciones = (tipo === 'Habilidad') ? data.abilities.map(a => a.ability.name) : data.moves.map(m => m.move.name);
                        opciones.sort();
                        mostrarOpcionesSimple(opciones, input, (tipo === 'Habilidad' ? 'ability' : 'move'));
                    });
            }
        }

        function mostrarOpcionesSimple(opciones, inputDestino, categoriaApi) {
            const lista = document.getElementById('panel-list');
            lista.innerHTML = '';
            opciones.forEach(slug => {
                const textoVisible = slug.replace(/-/g, ' ').toUpperCase();
                const li = document.createElement('li');
                li.textContent = textoVisible; 
                li.onclick = () => { inputDestino.value = textoVisible; cerrarPanel(); };
                li.onmouseenter = () => { cargarDetalles(categoriaApi, slug); };
                lista.appendChild(li);
            });
        }

        function cargarDetalles(categoria, slug) {
            const descBox = document.getElementById('panel-description');
            const apiSlug = slug.toLowerCase().replace(/ /g, '-');
            const cacheKey = `${categoria}:${apiSlug}`;

            if (detailsCache[cacheKey]) { pintarDetalles(detailsCache[cacheKey]); return; }
            descBox.innerHTML = '<p style="color:#FFDE00; text-align:center;">Cargando...</p>';

            fetch(`https://pokeapi.co/api/v2/${categoria}/${apiSlug}`)
                .then(res => { if(!res.ok) throw new Error("404"); return res.json(); })
                .then(data => {
                    const info = procesarInfoApi(data, categoria);
                    detailsCache[cacheKey] = info;
                    pintarDetalles(info);
                })
                .catch(err => { descBox.innerHTML = '<p style="color:red; text-align:center;">Detalles no disponibles.</p>'; });
        }

        function procesarInfoApi(data, categoria) {
            const nombreObj = data.names.find(n => n.language.name === 'es');
            const nombreEsp = nombreObj ? nombreObj.name : data.name;
            const flavorObj = data.flavor_text_entries.find(f => f.language.name === 'es');
            let descripcion = flavorObj ? flavorObj.flavor_text.replace(/\n|\f/g, ' ') : "Descripci贸n no disponible en espa帽ol.";
            
            let extraHtml = '';
            if (categoria === 'move') {
                const type = data.type.name;
                const damageClass = data.damage_class.name; 
                let classCss = (damageClass === 'physical') ? 'cat-physical' : (damageClass === 'special' ? 'cat-special' : 'cat-status');
                extraHtml = `<div style="margin-bottom:8px; display:flex; gap:5px;"><span class="move-stat-badge ${classCss}">${damageClass.toUpperCase()}</span><span class="move-stat-badge" style="border-color:var(--type-${type});color:var(--type-${type})">${type.toUpperCase()}</span><span class="move-stat-badge">Pot: ${data.power||'-'}</span></div>`;
            }
            return { nombre: nombreEsp, desc: descripcion, extra: extraHtml };
        }

        function pintarDetalles(info) {
            document.getElementById('panel-description').innerHTML = `<strong style="color:#FFDE00; font-size:1.1em; display:block; margin-bottom:5px;">${info.nombre}</strong>${info.extra}<p style="margin:0; color:#ddd;">${info.desc}</p>`;
        }

        function cerrarPanel() { document.getElementById('showdown-panel').classList.add('hidden'); }
        document.addEventListener('click', function(e) {
            const panel = document.getElementById('showdown-panel');
            if (!panel.classList.contains('hidden') && !e.target.closest('.showdown-panel') && !e.target.hasAttribute('readonly')) cerrarPanel();
        });

        // --- GUARDADO FINAL ---
        function guardarEquipoFinal() {
            const container = document.getElementById('detalles-container');
            const cards = container.querySelectorAll('.pokemon-detail-card');
            
            const listaFinalMiembros = []; // DEFINIDA AQU, ANTES DEL FOREACH

            cards.forEach(card => {
                const miembro = {
                    nombrePokemon: card.querySelector('.d-nombre').value,
                    mote: card.querySelector('.d-mote').value,
                    objeto: card.querySelector('.d-objeto').value,
                    habilidad: card.querySelector('.d-habilidad').value,
                    naturaleza: card.querySelector('.d-naturaleza').value,
                    movimiento1: card.querySelector('.d-move-1').value,
                    movimiento2: card.querySelector('.d-move-2').value,
                    movimiento3: card.querySelector('.d-move-3').value,
                    movimiento4: card.querySelector('.d-move-4').value
                };
                listaFinalMiembros.push(miembro);
            });

            // AHORA S PODEMOS USAR listaFinalMiembros
            const equipoDTO = {
                nombre: equipoTemporal.nombre,
                descripcion: equipoTemporal.descripcion,
                publico: equipoTemporal.publico,
                miembros: listaFinalMiembros
            };

            fetch('/equipos/guardar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(equipoDTO)
            })
            .then(res => res.text())
            .then(data => {
                if(data === "OK") { window.location.href = "/equipos"; } 
                else { alert("Error al guardar: " + data); }
            });
        }
    </script>
</body>
</html>