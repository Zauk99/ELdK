<!DOCTYPE html>
<html
  lang="es"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>El Diario de Kanto - Pokédex</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}" />
    <link rel="icon" th:href="@{/img/Logo.png}" />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
  </head>

  <body>
    <header class="header">
      <div class="header-container">
        <div class="logo-area">
          <a th:href="@{/}" class="site-title-link">
            <img th:src="@{/img/Logo.png}" alt="Logo" width="100px" />
          </a>
        </div>

        <div
          class="search-container"
          style="max-width: 400px; margin: 0 auto 20px auto"
        >
          <form
            id="pokeSearchForm"
            th:action="@{/pokedex}"
            method="get"
            style="
              display: flex;
              align-items: center;
              background-color: rgba(255, 255, 255, 0.2);
              border-radius: 5px;
              padding: 5px 10px;
              width: 100%;
              border: 1px solid rgba(255, 255, 255, 0.1);
            "
          >
            <input
              type="text"
              name="query"
              th:value="${queryActual}"
              placeholder="Buscar Pokémon..."
              style="
                background: none;
                border: none;
                outline: none;
                color: white;
                width: 100%;
                font-size: 1rem;
              "
              autocomplete="off"
            />

            <button
              type="submit"
              style="
                background: none;
                border: none;
                color: rgba(255, 255, 255, 0.8);
                cursor: pointer;
                padding: 5px;
              "
            >
              <i class="fas fa-search"></i>
            </button>
          </form>
        </div>

        <div style="display: flex; align-items: center">
          <a
            sec:authorize="hasRole('ADMIN')"
            th:href="@{/admin/crear-noticia}"
            class="admin-action-button"
          >
            <i class="fas fa-plus"></i> Añadir Noticia
          </a>

          <a sec:authorize="!isAuthenticated()" th:href="@{/login}">
            <button class="login-button">Iniciar Sesión</button>
          </a>

          <div sec:authorize="isAuthenticated()" class="user-menu-container">
            <button id="userMenuBtn" class="user-button">
              <img
                th:src="${#authentication.principal.fotoPerfilUrl}"
                alt="Avatar"
                class="user-avatar"
                style="object-fit: cover"
              />

              <span th:text="${#authentication.principal.username}"
                >Usuario</span
              >
              <i class="fas fa-chevron-down"></i>
            </button>

            <div id="userDropdown" class="user-dropdown-content">
              <a
                th:href="@{/perfil}"
                class="dropdown-item"
                style="
                  display: block;
                  padding: 12px 16px;
                  color: white;
                  text-decoration: none;
                  border-bottom: 1px solid #444;
                  text-align: left;
                "
              >
                <i class="fas fa-user" style="width: 20px"></i> Ver Perfil
              </a>

              <form th:action="@{/logout}" method="post" style="margin: 0">
                <button
                  type="submit"
                  style="width: 100%; text-align: left; padding: 12px 16px"
                >
                  <i class="fas fa-sign-out-alt" style="width: 20px"></i> Cerrar
                  Sesión
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
      <br />

      <nav class="secondary-nav-bar">
        <div class="nav-tabs-wrapper">
          <a th:href="@{/}" class="nav-item">
            <i class="fas fa-newspaper"></i> Noticias
          </a>
          <a th:href="@{/pokedex}" class="nav-item active">
            <i class="fas fa-globe"></i> Pokédex
          </a>
          <a th:href="@{/equipos}" class="nav-item">
            <i class="fas fa-users"></i> Equipos
          </a>
          <a th:href="@{/minijuegos}" class="nav-item">
            <i class="fas fa-gamepad"></i> Minijuegos
          </a>
        </div>
      </nav>
    </header>

    <main class="content-container">
      <div class="main-content-area">
        <section class="pokedex-section" id="pokedex-content">
          <div class="pokedex-header">
            <h2>Pokédex</h2>
            <div class="filter-dropdown-container" style="position: relative">
              <button
                id="filterBtn"
                onclick="toggleFilterPanel()"
                class="poke-button"
                style="
                  background-color: #333;
                  border: 1px solid #555;
                  padding: 10px 20px;
                  gap: 10px;
                "
              >
                <i class="fas fa-sliders-h"></i> Filtrar
                <span
                  th:if="${tipoActual != null or (genActual != null and genActual > 0)}"
                  style="
                    background: #ffde00;
                    color: #222;
                    border-radius: 50%;
                    width: 20px;
                    height: 20px;
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 0.8em;
                    margin-left: 5px;
                  "
                  >!</span
                >
              </button>

              <div id="filterPanel" class="filter-panel hidden">
                <div class="filter-header">
                  <h3>Filtros</h3>
                  <button onclick="toggleFilterPanel()" class="close-btn">
                    <i class="fas fa-times"></i>
                  </button>
                </div>

                <form
                  th:action="@{/pokedex}"
                  method="get"
                  id="advancedFilterForm"
                >
                  <div class="filter-section">
                    <div
                      class="filter-section-header"
                      onclick="toggleSection('typesSection')"
                    >
                      <span>Tipo</span>
                      <i
                        class="fas fa-chevron-down"
                        id="arrow-typesSection"
                      ></i>
                    </div>
                    <div id="typesSection" class="filter-options hidden">
                      <div class="checkbox-grid">
                        <label class="filter-option">
                          <input type="checkbox" name="tipo" value="normal"
                            th:checked="${tiposActuales != null && tiposActuales.contains('normal')}" />
                          Normal
                        </label>
                        <label class="filter-option">
                          <input type="checkbox" name="tipo" value="fighting"
                            th:checked="${tiposActuales != null && tiposActuales.contains('fighting')}" />
                          Lucha
                        </label>
                        <label class="filter-option">
                          <input type="checkbox" name="tipo" value="flying"
                            th:checked="${tiposActuales != null && tiposActuales.contains('flying')}" />
                          Volador
                        </label>
                        <label class="filter-option">
                          <input type="checkbox" name="tipo" value="poison"
                            th:checked="${tiposActuales != null && tiposActuales.contains('poison')}" />
                          Veneno
                        </label>
                        <label class="filter-option">
                          <input type="checkbox" name="tipo" value="ground"
                            th:checked="${tiposActuales != null && tiposActuales.contains('ground')}" />
                          Tierra
                        </label>
                        <label class="filter-option">
                          <input type="checkbox" name="tipo" value="rock"
                            th:checked="${tiposActuales != null && tiposActuales.contains('rock')}" />
                          Roca
                        </label>
                        <label class="filter-option">
                          <input type="checkbox" name="tipo" value="bug"
                            th:checked="${tiposActuales != null && tiposActuales.contains('bug')}" />
                          Bicho
                        </label>
                        <label class="filter-option">
                          <input type="checkbox" name="tipo" value="ghost"
                            th:checked="${tiposActuales != null && tiposActuales.contains('ghost')}" />
                          Fantasma
                        </label>
                        <label class="filter-option">
                          <input type="checkbox" name="tipo" value="steel"
                            th:checked="${tiposActuales != null && tiposActuales.contains('steel')}" />
                          Acero
                        </label>
                        <label class="filter-option">
                          <input type="checkbox" name="tipo" value="fire"
                            th:checked="${tiposActuales != null && tiposActuales.contains('fire')}" />
                          Fuego
                        </label>
                        <label class="filter-option">
                          <input type="checkbox" name="tipo" value="water"
                            th:checked="${tiposActuales != null && tiposActuales.contains('water')}" />
                          Agua
                        </label>
                        <label class="filter-option">
                          <input type="checkbox" name="tipo" value="grass"
                            th:checked="${tiposActuales != null && tiposActuales.contains('grass')}" />
                          Planta
                        </label>
                        <label class="filter-option">
                          <input type="checkbox" name="tipo" value="electric"
                            th:checked="${tiposActuales != null && tiposActuales.contains('electric')}" />
                          Eléctrico
                        </label>
                        <label class="filter-option">
                          <input type="checkbox" name="tipo" value="psychic"
                            th:checked="${tiposActuales != null && tiposActuales.contains('psychic')}" />
                          Psíquico
                        </label>
                        <label class="filter-option">
                          <input type="checkbox" name="tipo" value="ice"
                            th:checked="${tiposActuales != null && tiposActuales.contains('ice')}" />
                          Hielo
                        </label>
                        <label class="filter-option">
                          <input type="checkbox" name="tipo" value="dragon"
                            th:checked="${tiposActuales != null && tiposActuales.contains('dragon')}" />
                          Dragón
                        </label>
                        <label class="filter-option">
                          <input type="checkbox" name="tipo" value="dark"
                            th:checked="${tiposActuales != null && tiposActuales.contains('dark')}" />
                          Siniestro
                        </label>
                        <label class="filter-option">
                          <input type="checkbox" name="tipo" value="fairy"
                            th:checked="${tiposActuales != null && tiposActuales.contains('fairy')}" />
                          Hada
                        </label>
                      </div>
                    </div>
                  </div>

                  <div class="filter-section">
                    <div
                      class="filter-section-header"
                      onclick="toggleSection('genSection')"
                    >
                      <span>Generación</span>
                      <i class="fas fa-chevron-down" id="arrow-genSection"></i>
                    </div>
                    <div id="genSection" class="filter-options hidden">
                      <div class="radio-list">
                        <label class="filter-option full-width">
                          <input
                            type="radio"
                            name="gen"
                            value="0"
                            th:checked="${genActual == null or genActual == 0}"
                          />
                          Todas las Generaciones
                        </label>
                        <label class="filter-option full-width"
                          ><input
                            type="radio"
                            name="gen"
                            value="1"
                            th:checked="${genActual == 1}"
                          />
                          Gen 1 (Kanto)</label
                        >
                        <label class="filter-option full-width"
                          ><input
                            type="radio"
                            name="gen"
                            value="2"
                            th:checked="${genActual == 2}"
                          />
                          Gen 2 (Johto)</label
                        >
                        <label class="filter-option full-width"
                          ><input
                            type="radio"
                            name="gen"
                            value="3"
                            th:checked="${genActual == 3}"
                          />
                          Gen 3 (Hoenn)</label
                        >
                        <label class="filter-option full-width"
                          ><input
                            type="radio"
                            name="gen"
                            value="4"
                            th:checked="${genActual == 4}"
                          />
                          Gen 4 (Sinnoh)</label
                        >
                        <label class="filter-option full-width"
                          ><input
                            type="radio"
                            name="gen"
                            value="5"
                            th:checked="${genActual == 5}"
                          />
                          Gen 5 (Unova/Teselia)</label
                        >
                        <label class="filter-option full-width"
                          ><input
                            type="radio"
                            name="gen"
                            value="6"
                            th:checked="${genActual == 6}"
                          />
                          Gen 6 (Kalos)</label
                        >
                        <label class="filter-option full-width"
                          ><input
                            type="radio"
                            name="gen"
                            value="7"
                            th:checked="${genActual == 7}"
                          />
                          Gen 7 (Alola)</label
                        >
                        <label class="filter-option full-width"
                          ><input
                            type="radio"
                            name="gen"
                            value="8"
                            th:checked="${genActual == 8}"
                          />
                          Gen 8 (Galar)</label
                        >
                        <label class="filter-option full-width"
                          ><input
                            type="radio"
                            name="gen"
                            value="9"
                            th:checked="${genActual == 9}"
                          />
                          Gen 9 (Paldea)</label
                        >
                      </div>
                    </div>
                  </div>

                  <div class="filter-footer">
                    <a th:href="@{/pokedex}" class="reset-link"
                      >Eliminar filtros</a
                    >
                    <button type="submit" class="apply-btn">
                      Ver Resultados
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <div class="pokemon-grid">
            <a
              th:each="pokemon : ${pokemons}"
              th:href="@{/pokemon/{id}(id=${pokemon.id}, tipo=${tiposActuales}, gen=${genActual}, query=${queryActual})}"
              class="pokemon-card"
            >
              <span
                class="pokedex-number"
                th:text="'#' + ${#numbers.formatInteger(pokemon.id, 3)}"
                >#001</span
              >

              <div class="pokemon-image">
                <img th:src="${pokemon.imagenUrl}" th:alt="${pokemon.nombre}" />
              </div>

              <h4 th:text="${#strings.capitalize(pokemon.nombre)}">
                Bulbasaur
              </h4>
            </a>
          </div>

          <div
            class="pagination-controls"
            th:if="${!isSearch}"
            style="
              display: flex;
              justify-content: center;
              gap: 20px;
              margin-top: 30px;
            "
          >
            <a
              th:if="${hasPrevious}"
              th:href="@{/pokedex(page=${currentPage - 1})}"
              class="poke-button"
            >
              Anterior
            </a>

            <a
              th:if="${hasNext}"
              th:href="@{/pokedex(page=${currentPage + 1})}"
              class="poke-button"
            >
              Siguiente
            </a>
          </div>
        </section>
      </div>
    </main>
    <script src="js/main.js"></script>
    <script>
    // Variable global para rastrear el orden de selección de los tipos (FIFO)
    let seleccionadosOrden = [];

    /**
     * Inicialización principal al cargar la página.
     * Configura el buscador, inicializa el estado de los filtros y prepara los eventos.
     */
    document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("pokeSearchForm");
        const input = form.querySelector("input");
        let timeout = null;

        // 1. Lógica de búsqueda automática con "debounce" (espera 500ms tras dejar de escribir)
        input.addEventListener("input", function () {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                form.submit();
            }, 500);
        });

        // 2. Recuperar el foco y posicionar el cursor al final si hay una búsqueda activa
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has("query")) {
            input.focus();
            const val = input.value;
            input.value = "";
            input.value = val;
        }

        // 3. Inicializar el registro de tipos con los que ya vienen marcados desde el servidor.
        // Esto es crucial para que la persistencia al ir/volver no rompa el límite de 2.
        document.querySelectorAll('#typesSection input[type="checkbox"]:checked').forEach(cb => {
            seleccionadosOrden.push(cb.value);
        });

        // 4. Asignar el detector de cambios a todos los checkboxes de tipos
        document.querySelectorAll('#typesSection input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', gestionarSeleccionCircular);
        });
    });

    /**
     * Gestiona la selección circular de tipos (Máximo 2).
     * Si se selecciona un tercero, desmarca automáticamente el primero que se eligió.
     */
    function gestionarSeleccionCircular() {
        if (this.checked) {
            // Añadimos el nuevo tipo al final de nuestra "cola" de memoria
            seleccionadosOrden.push(this.value);

            // Si ahora hay 3 seleccionados, extraemos el primero (el más antiguo)
            if (seleccionadosOrden.length > 2) {
                const tipoAntiguo = seleccionadosOrden.shift();
                
                // Buscamos el checkbox físico del tipo antiguo y lo desmarcamos
                const checkboxAntiguo = document.querySelector(`#typesSection input[value="${tipoAntiguo}"]`);
                if (checkboxAntiguo) {
                    checkboxAntiguo.checked = false;
                }
            }
        } else {
            // Si el usuario desmarca un tipo manualmente, lo eliminamos del registro de orden
            seleccionadosOrden = seleccionadosOrden.filter(tipo => tipo !== this.value);
        }
    }

    /**
     * Alterna la visibilidad del panel principal de filtros avanzados.
     */
    function toggleFilterPanel() {
        const panel = document.getElementById("filterPanel");
        panel.classList.toggle("hidden");
    }

    /**
     * Maneja el comportamiento de acordeón para las secciones internas (Tipos y Generaciones).
     * @param {string} sectionId - El ID del div que se desea expandir o colapsar.
     */
    function toggleSection(sectionId) {
        const section = document.getElementById(sectionId);
        const arrow = document.getElementById("arrow-" + sectionId);

        if (section.classList.contains("hidden")) {
            section.classList.remove("hidden");
            arrow.classList.remove("fa-chevron-down");
            arrow.classList.add("fa-chevron-up");
        } else {
            section.classList.add("hidden");
            arrow.classList.remove("fa-chevron-up");
            arrow.classList.add("fa-chevron-down");
        }
    }

    /**
     * Escuchador global para cerrar el panel de filtros si el usuario hace clic fuera de él.
     */
    document.addEventListener("click", function (e) {
        const panel = document.getElementById("filterPanel");
        const btn = document.getElementById("filterBtn");

        // Solo cerramos si el panel está visible y el clic NO fue dentro del panel ni en el botón de apertura
        if (panel && !panel.classList.contains("hidden") &&
            !panel.contains(e.target) && !btn.contains(e.target)) {
            panel.classList.add("hidden");
        }
    });
</script>
  </body>
  <footer class="main-footer">
    <div class="footer-content-wrapper">
      <div class="footer-info">
        <img src="img/Logo.png" alt="Logo de la Pokédex" class="footer-logo" />
        <p class="description">
          Tu portal informativo sobre Pokémon favorito. Bienvenido a El Diario
          de Kanto!<br />
          Tu Pokédex interactiva. Explora detalles, movimientos y cadenas
          evolutivas de todos tus Pokémon favoritos.
          <br />¡Atrapa la información!
        </p>
      </div>

      <div class="footer-meta">
        <p class="creator">Creado por: Pablo Herrera Domínguez</p>
        <p class="copyright">
          ©2025 El Diario de Kanto. Todos los derechos reservados.
        </p>
        <p class="disclaimer">
          Nota: Esta web usa la API no oficial de Pokémon (PokeAPI). Pokémon y
          sus nombres son marcas registradas de Nintendo, Game Freak y The
          Pokémon Company.
        </p>
      </div>
    </div>
  </footer>
</html>