<!DOCTYPE html>
<html
  lang="es"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
>
  <head>
    <meta charset="UTF-8" />
    <title th:text="${equipo.nombre + ' | Detalles'}">Detalles Equipo</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style>
      .pokemon-detail-card {
        background: #2a2a2a;
        border: 1px solid #444;
        border-radius: 8px;
        padding: 20px;
        height: 100%;
        display: flex;
        flex-direction: column;
      }
      .pokemon-header {
        display: flex;
        align-items: center;
        gap: 15px;
        border-bottom: 1px solid #444;
        padding-bottom: 15px;
        margin-bottom: 15px;
      }
      .poke-img-box {
        width: 70px;
        height: 70px;
        background: #111;
        border-radius: 50%;
        border: 2px solid #555;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .data-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 0.9rem;
      }
      .label {
        color: #888;
      }
      .value {
        color: #ddd;
        font-weight: bold;
      }
      .moves-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-top: 15px;
      }
      .move-badge {
        background: #333;
        color: #ccc;
        padding: 6px;
        border-radius: 4px;
        text-align: center;
        font-size: 0.85rem;
        border: 1px solid #444;
      }
      .back-btn-container {
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="header-container">
        <div class="logo-area">
          <a th:href="@{/}" class="site-title-link">
            <img th:src="@{/img/Logo.png}" alt="Logo" width="100px" />
          </a>
        </div>

        <div sec:authorize="isAuthenticated()" class="user-menu-container">
          <button id="userMenuBtn" class="user-button">
            <img
              th:src="${#authentication.principal.fotoPerfilUrl}"
              alt="Avatar"
              class="user-avatar"
              style="object-fit: cover"
            />
            <span th:text="${#authentication.principal.username}">Usuario</span>
            <i class="fas fa-chevron-down"></i>
          </button>
          <div id="userDropdown" class="user-dropdown-content">
            <a th:href="@{/perfil}" class="dropdown-item"
              ><i class="fas fa-user"></i> Ver Perfil</a
            >
            <form th:action="@{/logout}" method="post" style="margin: 0">
              <button type="submit">
                <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
              </button>
            </form>
          </div>
        </div>
      </div>
      <br />
      <nav class="secondary-nav-bar">
        <div class="nav-tabs-wrapper">
          <a th:href="@{/}" class="nav-item"
            ><i class="fas fa-newspaper"></i> Noticias</a
          >
          <a th:href="@{/pokedex}" class="nav-item"
            ><i class="fas fa-globe"></i> Pok√©dex</a
          >
          <a th:href="@{/equipos}" class="nav-item active"
            ><i class="fas fa-users"></i> Equipos</a
          >
        </div>
      </nav>
    </header>

    <main class="content-container">
      <div class="main-content-area">
        <div class="back-btn-container">
          <a
            th:href="@{/equipos}"
            class="poke-button"
            style="display: inline-flex; width: auto; padding: 8px 15px"
          >
            <i class="fas fa-arrow-left"></i> Volver a Equipos
          </a>
        </div>

        <div style="background: #222; padding: 20px; border-radius: 10px; border-bottom: 3px solid #FFDE00; margin-bottom: 30px; position: relative;">
                
                <a th:href="@{/equipos/exportar/{id}(id=${equipo.id})}" target="_blank" 
                   class="poke-button" 
                   style="position: absolute; top: 20px; right: 20px; background-color: #3f51b5; padding: 8px 15px; font-size: 0.9em; color: white; text-decoration: none; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-file-pdf"></i> Exportar Showdown
                </a>

                <h1 style="color: #FFDE00; margin: 0;" th:text="${equipo.nombre}">Nombre Equipo</h1>
                <p style="color: #ccc; margin: 5px 0 0 0;" th:text="${equipo.descripcion}">Descripci√≥n...</p>
                <!-- <div style="margin-top: 10px;">
                     <span th:if="${equipo.publico}" style="background:#4CAF50; color:white; padding:2px 8px; border-radius:4px; font-size:0.8em;">P√∫blico</span>
                     <span th:if="${!equipo.publico}" style="background:#d32f2f; color:white; padding:2px 8px; border-radius:4px; font-size:0.8em;">Privado</span>
                </div> -->
            </div>

        <div
          style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
          "
        >
          <div th:each="m : ${equipo.miembros}" class="pokemon-detail-card">
            <div class="pokemon-header">
              <div class="poke-img-box">
                <img
                  th:src="@{'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/' + ${pokemonIds.get(#strings.toLowerCase(m.nombrePokemon))} + '.png'}"
                  style="width: 90%; height: auto"
                  onerror="this.onerror=null; this.src='https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png';"
                />
              </div>
              <div>
                <h3
                  style="margin: 0; color: white"
                  th:text="${#strings.capitalize(m.nombrePokemon)}"
                >
                  Pikachu
                </h3>
                <span
                  style="color: #aaa; font-style: italic; font-size: 0.9em"
                  th:text="${m.mote != null && !m.mote.isEmpty() ? '(' + m.mote + ')' : ''}"
                ></span>
              </div>
            </div>
            <div class="data-row">
              <span class="label">Objeto:</span>
              <span class="value" style="color: #ffde00" th:text="${m.objeto}"
                >Restos</span
              >
            </div>
            <div class="data-row">
              <span class="label">Habilidad:</span>
              <span class="value" th:text="${m.habilidad}">Presi√≥n</span>
            </div>
            <div class="data-row">
              <span class="label">Naturaleza:</span>
              <span class="value" th:text="${m.naturaleza}">Firme</span>
            </div>

            <div
              class="data-row"
              style="
                margin-top: 10px;
                background: #222;
                padding: 8px;
                border-radius: 4px;
                border: 1px solid #444;
              "
            >
              <span
                class="label"
                style="
                  display: block;
                  margin-bottom: 4px;
                  font-size: 0.8em;
                  color: #ffde00;
                "
                >EVs (Esfuerzo):</span
              >
              <div style="font-size: 0.85em; color: #ccc; line-height: 1.4">
                <span
                  th:if="${m.hpEv > 0}"
                  th:text="${m.hpEv} + ' HP / '"
                ></span>
                <span
                  th:if="${m.attackEv > 0}"
                  th:text="${m.attackEv} + ' Atk / '"
                ></span>
                <span
                  th:if="${m.defenseEv > 0}"
                  th:text="${m.defenseEv} + ' Def / '"
                ></span>
                <span
                  th:if="${m.spAttackEv > 0}"
                  th:text="${m.spAttackEv} + ' SpA / '"
                ></span>
                <span
                  th:if="${m.spDefenseEv > 0}"
                  th:text="${m.spDefenseEv} + ' SpD / '"
                ></span>
                <span
                  th:if="${m.speedEv > 0}"
                  th:text="${m.speedEv} + ' Spe'"
                ></span>

                <span
                  th:if="${m.hpEv == 0 and m.attackEv == 0 and m.defenseEv == 0 and m.spAttackEv == 0 and m.spDefenseEv == 0 and m.speedEv == 0}"
                >
                  Sin entrenamiento
                </span>
              </div>
            </div>
            <div class="moves-grid">
              <div class="move-badge" th:text="${m.movimiento1}">-</div>
              <div class="move-badge" th:text="${m.movimiento2}">-</div>
              <div class="move-badge" th:text="${m.movimiento3}">-</div>
              <div class="move-badge" th:text="${m.movimiento4}">-</div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer class="main-footer">
      <div class="footer-content-wrapper">
        <div class="footer-info">
          <img
            th:src="@{/img/Logo.png}"
            alt="Logo de la Pok√©dex"
            class="footer-logo"
          />
          <p class="description">
            Tu portal informativo sobre Pok√©mon favorito. Bienvenido a El Diario
            de Kanto!<br />
            Tu Pok√©dex interactiva. Explora detalles, movimientos y cadenas
            evolutivas de todos tus Pok√©mon favoritos.
            <br />¬°Atrapa la informaci√≥n!
          </p>
        </div>

        <div class="footer-meta">
          <p class="creator">Creado por: Pablo Herrera Dom√≠nguez</p>
          <p class="copyright">
            ¬©2025 El Diario de Kanto. Todos los derechos reservados.
          </p>
          <p class="disclaimer">
            Nota: Esta web usa la API no oficial de Pok√©mon (PokeAPI). Pok√©mon y
            sus nombres son marcas registradas de Nintendo, Game Freak y The
            Pok√©mon Company.
          </p>
        </div>
      </div>
    </footer><div id="move-tooltip">
        <div id="tooltip-content"></div>
    </div>

    <script th:src="@{/js/main.js}"></script>
    <script>
    // ============================================
    // 1. CONFIGURACI√ìN Y UTILIDADES
    // ============================================
    const TYPE_COLORS = {
        'normal': '#A8A77A', 'fire': '#EE8130', 'water': '#6390F0', 'electric': '#F7D02C',
        'grass': '#7AC74C', 'ice': '#96D9D6', 'fighting': '#C22E28', 'poison': '#A33EA1',
        'ground': '#E2BF65', 'flying': '#A98FF3', 'psychic': '#F95587', 'bug': '#A6B91A',
        'rock': '#B6A136', 'ghost': '#735797', 'dragon': '#6F35FC', 'steel': '#B7B7CE',
        'fairy': '#D685AD', 'dark': '#705746'
    };

    // NUEVO: Diccionario de Tipos
    const TYPE_TRANS = {
        'normal': 'Normal', 'fire': 'Fuego', 'water': 'Agua', 'electric': 'El√©ctrico',
        'grass': 'Planta', 'ice': 'Hielo', 'fighting': 'Lucha', 'poison': 'Veneno',
        'ground': 'Tierra', 'flying': 'Volador', 'psychic': 'Ps√≠quico', 'bug': 'Bicho',
        'rock': 'Roca', 'ghost': 'Fantasma', 'dragon': 'Drag√≥n', 'steel': 'Acero',
        'fairy': 'Hada', 'dark': 'Siniestro'
    };

    const CAT_TRANS = { 'physical': 'F√≠sico', 'special': 'Especial', 'status': 'Estado' };
    const moveCache = {};

    function darkenColor(hex, percent) {
        let r = parseInt(hex.substring(1, 3), 16);
        let g = parseInt(hex.substring(3, 5), 16);
        let b = parseInt(hex.substring(5, 7), 16);
        r = parseInt(r * (100 - percent) / 100); g = parseInt(g * (100 - percent) / 100); b = parseInt(b * (100 - percent) / 100);
        r = (r < 255) ? r : 255; g = (g < 255) ? g : 255; b = (b < 255) ? b : 255;
        return "#" + ((r.toString(16).length==1)?"0"+r.toString(16):r.toString(16)) + ((g.toString(16).length==1)?"0"+g.toString(16):g.toString(16)) + ((b.toString(16).length==1)?"0"+b.toString(16):b.toString(16));
    }

    // ============================================
    // 2. L√ìGICA DE EVENTOS
    // ============================================
    const tooltip = document.getElementById('move-tooltip');
    const content = document.getElementById('tooltip-content');
    const badges = document.querySelectorAll('.move-badge');

    badges.forEach(badge => {
        const moveNameEs = badge.textContent.trim();
        if(moveNameEs === '-' || !moveNameEs) return; 

        badge.addEventListener('mousemove', (e) => {
            const tooltipWidth = tooltip.offsetWidth || 250;
            const viewportWidth = window.innerWidth;
            const cursorX = e.pageX;
            const cursorY = e.pageY;
            const offset = 15;

            let leftPos = cursorX + offset; 
            if (leftPos + tooltipWidth > viewportWidth - 20) {
                leftPos = cursorX - tooltipWidth - offset;
            }

            tooltip.style.left = leftPos + 'px';
            tooltip.style.top = (cursorY + offset) + 'px';
        });

        badge.addEventListener('mouseenter', () => {
            tooltip.style.display = 'block';
            if(content.innerHTML === '') content.innerHTML = '...'; 
            
            if (moveCache[moveNameEs]) {
                renderTooltip(moveCache[moveNameEs], badge);
                return;
            }

            content.innerHTML = '<span style="color:#FFDE00">Cargando datos<span class="loading-dots"></span></span>';

            const query = `
                query {
                  pokemon_v2_move(where: {pokemon_v2_movenames: {name: {_eq: "${moveNameEs}"}, language_id: {_eq: 7}}}) {
                    name
                    power
                    accuracy
                    pp
                    pokemon_v2_type { name }
                    pokemon_v2_movedamageclass { name }
                    pokemon_v2_movenames(where: {language_id: {_eq: 7}}) { name }
                    pokemon_v2_moveflavortexts(where: {language_id: {_eq: 7}}, limit: 1, order_by: {version_group_id: desc}) { flavor_text }
                  }
                }
            `;

            fetch('https://beta.pokeapi.co/graphql/v1beta', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: query })
            })
            .then(res => res.json())
            .then(res => {
                if (res.errors) {
                    console.error("Error GraphQL:", res.errors);
                    content.innerHTML = '<span style="color:red">Error en API</span>';
                    return;
                }
                const data = res.data && res.data.pokemon_v2_move ? res.data.pokemon_v2_move[0] : null;
                if(data) {
                    moveCache[moveNameEs] = data;
                    renderTooltip(data, badge);
                } else {
                    content.innerHTML = '<span style="color:red">Datos no encontrados</span>';
                }
            })
            .catch(err => {
                console.error(err);
                content.innerHTML = '<span style="color:red">Error de conexi√≥n</span>';
            });
        });

        badge.addEventListener('mouseleave', () => {
            tooltip.style.display = 'none';
            badge.style.backgroundColor = '#333';
            badge.style.borderColor = '#444';
            badge.style.color = '#ccc';
        });
    });

    function renderTooltip(data, badgeElement) {
        const typeEng = data.pokemon_v2_type.name;
        const category = data.pokemon_v2_movedamageclass.name;
        const desc = data.pokemon_v2_moveflavortexts[0]?.flavor_text.replace(/\n|\f/g, ' ') || "Sin descripci√≥n.";
        const finalName = data.pokemon_v2_movenames[0]?.name || data.name;

        // Traducciones
        const typeEsp = TYPE_TRANS[typeEng] || typeEng;
        const catEsp = CAT_TRANS[category] || category;

        // Colores
        const baseColor = TYPE_COLORS[typeEng] || '#333';
        const darkColor = darkenColor(baseColor, 40);
        
        badgeElement.style.backgroundColor = darkColor;
        badgeElement.style.borderColor = baseColor;
        badgeElement.style.color = 'white';

        const catClass = category === 'physical' ? 'cat-physical' : (category === 'special' ? 'cat-special' : 'cat-status');
        
        // HTML DEL TOOLTIP (Con el nuevo badge de TIPO)
        content.innerHTML = `
            <div class="tooltip-header" style="flex-wrap: wrap; gap: 5px;">
                <span class="tooltip-title" style="width: 100%; display: block; margin-bottom: 5px;">${finalName}</span>
                
                <span class="tooltip-cat ${catClass}">${catEsp}</span>

                <span class="tooltip-cat" style="background-color: ${baseColor}; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
                    ${typeEsp.toUpperCase()}
                </span>
            </div>

            <div class="tooltip-stats">
                <span>‚ö° Pot: ${data.power || '-'}</span>
                <span>üéØ Prec: ${data.accuracy || '-'}%</span>
                <span>üíß PP: ${data.pp}</span>
            </div>
            <div class="tooltip-desc">${desc}</div>
        `;
    }
</script>
    </body>
  </body>
</html>
